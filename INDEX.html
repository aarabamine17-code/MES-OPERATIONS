<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>G√©n√©rateur de Documents</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<style>
  body { font-family:"Times New Roman", serif; margin:0; padding:20mm; background:#f7f7f7; }
  .app { max-width:210mm; margin:auto; background:white; padding:25mm; box-shadow:0 0 10px rgba(0,0,0,0.1); position:relative; min-height:297mm; }
  .controls { margin-bottom:20px; }
  label { display:block; margin-top:10px; font-size:15px; }
  select, input, textarea { width:100%; padding:6px; font-size:15px; margin-top:4px; }
  button { 
    margin-top:15px; 
    padding:12px 24px; 
    font-size:15px; 
    cursor:pointer; 
    margin-right:10px; 
    border: none;
    border-radius: 6px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .btn-primary {
    background: #2c3e50;
    color: white;
  }
  .btn-primary:hover {
    background: #34495e;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  .btn-secondary {
    background: #7f8c8d;
    color: white;
  }
  .btn-secondary:hover {
    background: #95a5a6;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  .btn-info {
    background: #3498db;
    color: white;
  }
  .btn-info:hover {
    background: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  .letter { font-size:15px; line-height:1.8; text-align:justify; white-space:pre-line; position:relative; z-index:1; }
  .right { text-align:right; margin-bottom:20px; }
  .left { text-align:left; margin:15px 0; font-weight:bold; }
  .center { text-align:center; margin:15px 0; }
  .signature { text-align:center; margin-top:40px; }
  .letter-header { 
    position:absolute; 
    top:10mm; 
    left:25mm; 
    font-weight:bold; 
    font-size:20px;
    text-transform: uppercase;
    z-index: 2;
  }
  .letter-footer {
    position:absolute;
    bottom:10mm;
    left:25mm;
    right:25mm;
    font-size:12px;
    text-align:center;
    white-space: pre-line;
    line-height:1.4;
    z-index: 2;
  }
  .checkbox-container { margin:15px 0; }
  .checkbox-container input { width:auto; margin-right:8px; }
  b { font-weight:bold; }
  .no-print { margin-bottom:15px; }
  .document-type { margin-bottom:15px; }
  .document-type select { width:auto; padding:8px; font-size:16px; font-weight:bold; }
  .virement-fields, .releve-fields, .mise-fields, .credit-fields, .debit-fields { display:none; }
  .upload-section { margin:20px 0; padding:15px; background:#f0f0f0; border-radius:5px; }
  .file-input { margin:10px 0; }
  .status-message { margin:10px 0; padding:10px; border-radius:3px; }
  .success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
  .error { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
  .info { background:#d1ecf1; color:#0c5460; border:1px solid #bee5eb; }
  .month-year-container { display:flex; gap:10px; }
  .month-year-container select { flex:1; }
  .table-container { margin:20px 0; }
  table { width:100%; border-collapse: collapse; margin:10px 0; }
  th, td { border:1px solid #ddd; padding:8px; text-align:left; }
  th { background-color:#f2f2f2; font-weight:bold; }
  .banque-section { margin-bottom:30px; page-break-inside: avoid; }
  .banque-title { background:#ecf0f1; padding:10px; font-weight:bold; margin-bottom:10px; }
  .mode-selection { margin:15px 0; padding:10px; background:#f8f9fa; border-radius:5px; }
  .mode-buttons { display:flex; gap:10px; margin:10px 0; }
  .mode-btn { 
    flex:1; 
    padding:10px; 
    border:2px solid #2c3e50; 
    background:white; 
    color:#2c3e50; 
    border-radius:5px; 
    cursor:pointer;
    text-align:center;
    font-weight:600;
    transition: all 0.3s ease;
  }
  .mode-btn.active {
    background:#2c3e50;
    color:white;
  }
  .manuel-fields, .excel-fields { display:none; }
  .excel-template { 
    display: none;
    margin-top: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 5px;
    border-left: 4px solid #3498db;
  }
  .template-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
    font-size: 14px;
  }
  .template-table th {
    background: #3498db;
    color: white;
    padding: 10px;
    text-align: center;
  }
  .template-table td {
    border: 1px solid #ddd;
    padding: 8px;
    background: white;
  }
  .template-example {
    background: #e8f4fc !important;
    font-style: italic;
    color: #2c3e50;
  }
  .site-title {
    text-align: center;
    font-size: 32px;
    font-weight: bold;
    margin-bottom: 30px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    padding: 15px;
    border-radius: 10px;
    border: 3px solid #2c3e50;
  }
  .developer-info {
    text-align: center;
    margin-top: 30px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
    border-top: 3px solid #3498db;
  }
  .developer-name {
    font-weight: bold;
    color: #2c3e50;
    font-size: 18px;
  }
  .developer-contact {
    color: #7f8c8d;
    font-size: 16px;
    margin-top: 5px;
  }
  .download-link {
    color: #3498db;
    text-decoration: none;
    font-weight: bold;
    border: 1px solid #3498db;
    padding: 5px 10px;
    border-radius: 4px;
    transition: all 0.3s ease;
  }
  .download-link:hover {
    background: #3498db;
    color: white;
    text-decoration: none;
  }
  @media print {
    .no-print { display:none; }
    body { background:white; padding:0; margin:0; }
    .app { box-shadow:none; padding:25mm; margin:0; width:100%; height:100%; position:relative; }
    .letter-header { 
      position:fixed; 
      top:10mm; 
      left:25mm; 
      right:25mm;
      font-weight:bold; 
      font-size:20px;
      text-transform: uppercase;
    }
    .letter-footer {
      position:fixed;
      bottom:10mm;
      left:25mm;
      right:25mm;
      font-size:12px;
      text-align:center;
      white-space: pre-line;
      line-height:1.4;
    }
    .banque-section { page-break-inside: avoid; }
    .letter { margin-top: 20mm; margin-bottom: 20mm; }
    .site-title, .developer-info { display: none; }
  }
</style>
</head>
<body>
<div class="app">
  <!-- Grand titre du site -->
  <div class="site-title no-print">
     MES OP√âRATIONS BANCAIRES 
  </div>

  <div class="no-print controls">
    <div class="upload-section">
      <h3>Charger le fichier Excel de r√©f√©rence</h3>
      <input type="file" id="excelFile" class="file-input" accept=".xlsx, .xls">
      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button onclick="loadExcelFile()" class="btn-primary">Charger les donn√©es</button>
        <button onclick="toggleExcelTemplate()" class="btn-info">Voir le mod√®le Excel</button>
      </div>
      <div id="uploadStatus" class="status-message"></div>
      
      <!-- Section cach√©e avec le mod√®le Excel -->
      <div id="excelTemplate" class="excel-template">
        <h4>üìä Mod√®le de fichier Excel requis :</h4>
        <p><strong>Structure des colonnes :</strong></p>
        
        <table class="template-table">
          <thead>
            <tr>
              <th>Ordonneur</th>
              <th>BANQUE</th>
              <th>AGENCE</th>
              <th>Compte</th>
              <th>NOM</th>
              <th>INFORMATION SOCIETE (PIED DE PAGE)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="template-example">ALPHA BMCE</td>
              <td class="template-example">BANK OF AFRICA</td>
              <td class="template-example">RABAT</td>
              <td class="template-example">12345678901</td>
              <td class="template-example">SOCIETE ALPHA</td>
              <td class="template-example">SOCIETE ALPHA - Capital 100.000 DH - RC 12345</td>
            </tr>
            <tr>
              <td>Nom du compte </td>
              <td>Nom de la banque(bmci/banque populaire)</td>
              <td>Agence (optionnel)</td>
              <td>Num√©ro de compte (RIB)</td>
              <td>Nom</td>
              <td>Pied de page (optionnel)</td>
            </tr>
          </tbody>
        </table>
        
        <div style="margin-top: 15px;">
          <p><strong>üí° Conseils :</strong></p>
          <ul style="margin: 10px 0; padding-left: 20px;">
            <li>Les colonnes <strong>Ordonneur, BANQUE, Compte, NOM</strong> sont obligatoires</li>
            <li>Utilisez le format : <code>NOM_SOCIETE - TYPE_COMPTE</code> pour l'ordonneur</li>
            <li>Les fichiers <strong>.xlsx</strong> et <strong>.xls</strong> sont accept√©s</li>
            <li>√âvitez les cellules vides dans les colonnes obligatoires</li>
            <li>Pour t√©l√©charger le mod√®le, <a href="https://docs.google.com/spreadsheets/d/1aC21EGEdwdt-jo8QawhAmMrD_q64Rjk-/edit?usp=sharing&ouid=106645687971409921292&rtpof=true&sd=true" target="_blank" class="download-link">cliquez ici</a></li>
          </ul>
        </div>
        
        <button onclick="toggleExcelTemplate()" class="btn-secondary" style="margin-top: 10px;">Fermer</button>
      </div>
    </div>
    
    <div class="document-type">
      <label>Type de document :
        <select id="documentType">
          <option value="virement">Ordre de Virement</option>
          <option value="mise">Mise √† disposition</option>
          <option value="releve">Demande de Relev√© de Compte</option>
          <option value="credit">Demande avis de cr√©dit</option>
          <option value="debit">Demande avis de d√©bit</option>
        </select>
      </label>
    </div>
    
    <!-- Ajout du champ Ville -->
    <label>Ville : <input type="text" id="ville" value="RABAT" placeholder="Saisir votre ville"></label>
    
    <label>Date : <input type="date" id="date"></label>
    
    <div class="virement-fields">
      <div class="mode-selection">
        <label><strong>Mode de saisie :</strong></label>
        <div class="mode-buttons">
          <div class="mode-btn active" onclick="setVirementMode('manuel')">Saisie Manuelle</div>
          <div class="mode-btn" onclick="setVirementMode('excel')">S√©lection Excel</div>
        </div>
      </div>
      
      <div class="manuel-fields">
        <label>Nom de l'√©metteur : <input type="text" id="emetteurManuel" placeholder="Nom de votre soci√©t√©"></label>
        <label>Compte √©metteur : <input type="text" id="compteEmetteurManuel" placeholder="Num√©ro de compte"></label>
        <label>Banque √©metteur : <input type="text" id="banqueEmetteurManuel" placeholder="Nom de la banque"></label>
        <label>Nom du b√©n√©ficiaire : <input type="text" id="beneficiaireManuel" placeholder="Nom du b√©n√©ficiaire"></label>
        <label>Compte b√©n√©ficiaire : <input type="text" id="compteBeneficiaireManuel" placeholder="Num√©ro de compte b√©n√©ficiaire"></label>
        <label>Banque b√©n√©ficiaire : <input type="text" id="banqueBeneficiaireManuel" placeholder="Banque du b√©n√©ficiaire"></label>
      </div>
      
      <div class="excel-fields">
        <label>Ordonneur (Compte) :
          <select id="ordon"></select>
        </label>
        
        <label>B√©n√©ficiaire (Compte) :
          <select id="benif"></select>
        </label>
      </div>
      
      <label>Montant en chiffres (Dhs) : <input type="number" id="montantChiffre"></label>
      
      <label>Motif du virement (optionnel) : <textarea id="motifVirement" placeholder="Raison du virement... (laisser vide pour ne pas afficher)"></textarea></label>
      
      <div class="checkbox-container">
        <label><input type="checkbox" id="srbm"> SRBM (VIREMENT EXPRESS) </label>
      </div>
    </div>
    
    <div class="mise-fields">
      <div class="mode-selection">
        <label><strong>Mode de saisie :</strong></label>
        <div class="mode-buttons">
          <div class="mode-btn active" onclick="setMiseMode('manuel')">Saisie Manuelle</div>
          <div class="mode-btn" onclick="setMiseMode('excel')">S√©lection Excel</div>
        </div>
      </div>
      
      <div class="manuel-mise-fields">
        <label>Compte √† d√©biter : <input type="text" id="compteMiseManuel" placeholder="Num√©ro de compte"></label>
        <label>Banque du compte : <input type="text" id="banqueMiseManuel" placeholder="Nom de la banque"></label>
        <label>Agence (optionnel) : <input type="text" id="agenceMiseManuel" placeholder="Agence"></label>
      </div>
      
      <div class="excel-mise-fields" style="display:none;">
        <label>Compte √† d√©biter :
          <select id="compteMise"></select>
        </label>
      </div>
      
      <label>Montant en chiffres (Dhs) : <input type="number" id="montantMise"></label>
      
      <label>Nom du b√©n√©ficiaire : <input type="text" id="nomBeneficiaire" placeholder="Ex: AMINE MOHAMED"></label>
      
      <label>Num√©ro de CIN : <input type="text" id="cinBeneficiaire" placeholder="Ex: AD123456"></label>
    </div>
    
    <div class="releve-fields">
      <div class="mode-selection">
        <label><strong>Mode de saisie :</strong></label>
        <div class="mode-buttons">
          <div class="mode-btn active" onclick="setReleveMode('manuel')">Saisie Manuelle</div>
          <div class="mode-btn" onclick="setReleveMode('excel')">S√©lection Excel</div>
        </div>
      </div>
      
      <div class="manuel-releve-fields">
        <label>Compte demand√© : <input type="text" id="compteReleveManuel" placeholder="Num√©ro de compte"></label>
        <label>Banque du compte : <input type="text" id="banqueReleveManuel" placeholder="Nom de la banque"></label>
        <label>Agence (optionnel) : <input type="text" id="agenceReleveManuel" placeholder="Agence"></label>
      </div>
      
      <div class="excel-releve-fields" style="display:none;">
        <label>Compte demand√© :
          <select id="compteReleve"></select>
        </label>
      </div>
      
      <label>P√©riode du relev√© :</label>
      <div class="month-year-container">
        <select id="moisReleve">
          <option value="01">Janvier</option>
          <option value="02">F√©vrier</option>
          <option value="03">Mars</option>
          <option value="04">Avril</option>
          <option value="05">Mai</option>
          <option value="06">Juin</option>
          <option value="07">Juillet</option>
          <option value="08">Ao√ªt</option>
          <option value="09">Septembre</option>
          <option value="10">Octobre</option>
          <option value="11">Novembre</option>
          <option value="12">D√©cembre</option>
        </select>
        
        <select id="anneeReleve">
          <!-- Les ann√©es seront g√©n√©r√©es dynamiquement -->
        </select>
      </div>
    </div>
    
    <div class="credit-fields">
      <div class="mode-selection">
        <label><strong>Mode de saisie :</strong></label>
        <div class="mode-buttons">
          <div class="mode-btn active" onclick="setCreditMode('manuel')">Saisie Manuelle</div>
          <div class="mode-btn" onclick="setCreditMode('excel')">S√©lection Excel</div>
        </div>
      </div>
      
      <div class="manuel-credit-fields">
        <label>Compte concern√© : <input type="text" id="compteCreditManuel" placeholder="Num√©ro de compte"></label>
        <label>Banque du compte : <input type="text" id="banqueCreditManuel" placeholder="Nom de la banque"></label>
        <label>Agence (optionnel) : <input type="text" id="agenceCreditManuel" placeholder="Agence"></label>
      </div>
      
      <div class="excel-credit-fields" style="display:none;">
        <label>Compte concern√© :
          <select id="compteCredit"></select>
        </label>
      </div>
      
      <label>Date de l'op√©ration : <input type="date" id="dateOperationCredit"></label>
      
      <label>Montant en chiffres (Dhs) : <input type="number" id="montantCredit"></label>
      
      <label>Libell√© de l'op√©ration : <textarea id="libelleCredit" placeholder="D√©crire l'op√©ration de cr√©dit..."></textarea></label>
    </div>
    
    <div class="debit-fields">
      <div class="mode-selection">
        <label><strong>Mode de saisie :</strong></label>
        <div class="mode-buttons">
          <div class="mode-btn active" onclick="setDebitMode('manuel')">Saisie Manuelle</div>
          <div class="mode-btn" onclick="setDebitMode('excel')">S√©lection Excel</div>
        </div>
      </div>
      
      <div class="manuel-debit-fields">
        <label>Compte concern√© : <input type="text" id="compteDebitManuel" placeholder="Num√©ro de compte"></label>
        <label>Banque du compte : <input type="text" id="banqueDebitManuel" placeholder="Nom de la banque"></label>
        <label>Agence (optionnel) : <input type="text" id="agenceDebitManuel" placeholder="Agence"></label>
      </div>
      
      <div class="excel-debit-fields" style="display:none;">
        <label>Compte concern√© :
          <select id="compteDebit"></select>
        </label>
      </div>
      
      <label>Date de l'op√©ration : <input type="date" id="dateOperationDebit"></label>
      
      <label>Montant en chiffres (Dhs) : <input type="number" id="montantDebit"></label>
      
      <label>Libell√© de l'op√©ration : <textarea id="libelleDebit" placeholder="D√©crire l'op√©ration de d√©bit..."></textarea></label>
    </div>
    
    <div class="checkbox-container">
      <label><input type="checkbox" id="headerCheckbox"> Ajouter l'en-t√™te et pied de page de soci√©t√©</label>
    </div>
    
    <button onclick="generateDocument()" class="btn-primary">G√©n√©rer</button>
    <button onclick="window.print()" class="btn-secondary">Imprimer</button>
    
    <!-- Informations du d√©veloppeur -->
    <div class="developer-info no-print">
      <div class="developer-name">D√©velopp√© par: AA.LENS</div>
      <div class="developer-contact">Contact: aarabamine17@gmail.com INSTA:2A.LENS </div>
    </div>
  </div>

  <div class="letter" id="documentOutput"></div>
</div>

<!-- Inclure SheetJS pour lire les fichiers Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
// Variables globales
let refData = [];
let ordonChoice, benifChoice, compteReleveChoice, compteMiseChoice, compteCreditChoice, compteDebitChoice;
let virementMode = 'manuel'; // 'manuel' ou 'excel'
let miseMode = 'manuel';
let releveMode = 'manuel';
let creditMode = 'manuel';
let debitMode = 'manuel';

// Fonction pour afficher/masquer le mod√®le Excel
function toggleExcelTemplate() {
  const template = document.getElementById('excelTemplate');
  if (template.style.display === 'none' || template.style.display === '') {
    template.style.display = 'block';
  } else {
    template.style.display = 'none';
  }
}

// Fonctions pour changer le mode de saisie
function setVirementMode(mode) {
  virementMode = mode;
  
  // Mettre √† jour les boutons
  document.querySelectorAll('.virement-fields .mode-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // Afficher/masquer les champs appropri√©s
  if (mode === 'manuel') {
    document.querySelector('.virement-fields .manuel-fields').style.display = 'block';
    document.querySelector('.virement-fields .excel-fields').style.display = 'none';
  } else {
    document.querySelector('.virement-fields .manuel-fields').style.display = 'none';
    document.querySelector('.virement-fields .excel-fields').style.display = 'block';
  }
}

function setMiseMode(mode) {
  miseMode = mode;
  
  document.querySelectorAll('.mise-fields .mode-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  if (mode === 'manuel') {
    document.querySelector('.manuel-mise-fields').style.display = 'block';
    document.querySelector('.excel-mise-fields').style.display = 'none';
  } else {
    document.querySelector('.manuel-mise-fields').style.display = 'none';
    document.querySelector('.excel-mise-fields').style.display = 'block';
  }
}

function setReleveMode(mode) {
  releveMode = mode;
  
  document.querySelectorAll('.releve-fields .mode-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  if (mode === 'manuel') {
    document.querySelector('.manuel-releve-fields').style.display = 'block';
    document.querySelector('.excel-releve-fields').style.display = 'none';
  } else {
    document.querySelector('.manuel-releve-fields').style.display = 'none';
    document.querySelector('.excel-releve-fields').style.display = 'block';
  }
}

function setCreditMode(mode) {
  creditMode = mode;
  
  document.querySelectorAll('.credit-fields .mode-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  if (mode === 'manuel') {
    document.querySelector('.manuel-credit-fields').style.display = 'block';
    document.querySelector('.excel-credit-fields').style.display = 'none';
  } else {
    document.querySelector('.manuel-credit-fields').style.display = 'none';
    document.querySelector('.excel-credit-fields').style.display = 'block';
  }
}

function setDebitMode(mode) {
  debitMode = mode;
  
  document.querySelectorAll('.debit-fields .mode-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  if (mode === 'manuel') {
    document.querySelector('.manuel-debit-fields').style.display = 'block';
    document.querySelector('.excel-debit-fields').style.display = 'none';
  } else {
    document.querySelector('.manuel-debit-fields').style.display = 'none';
    document.querySelector('.excel-debit-fields').style.display = 'block';
  }
}

// Initialisation des ann√©es pour le relev√©
function initAnnees() {
  const anneeSelect = document.getElementById('anneeReleve');
  const anneeActuelle = new Date().getFullYear();
  
  // Ajouter 5 ann√©es (2 avant, ann√©e actuelle, 2 apr√®s)
  for (let i = anneeActuelle - 2; i <= anneeActuelle + 2; i++) {
    const option = document.createElement('option');
    option.value = i;
    option.textContent = i;
    if (i === anneeActuelle) option.selected = true;
    anneeSelect.appendChild(option);
  }
}

// G√©n√©ration des options HTML
function renderOptions(data, type = "ordon") {
  if (!data || data.length === 0) {
    return '<option value="">Aucune donn√©e charg√©e</option>';
  }
  
  return data.map(r =>
    `<option value="${r.compte}" data-banq="${r.banque}" data-agence="${r.agence || ''}" data-name="${type === "ordon" ? r.ordon : r.benif}" data-footer="${r.footer || ''}">
      ${type === "ordon" ? r.ordon : r.benif} ‚Äî ${r.compte} (${r.banque})
    </option>`
  ).join("");
}

// Initialiser les s√©lecteurs
function initSelects() {
  document.getElementById("ordon").innerHTML = renderOptions(refData, "ordon");
  document.getElementById("benif").innerHTML = renderOptions(refData, "benif");
  document.getElementById("compteReleve").innerHTML = renderOptions(refData, "ordon");
  document.getElementById("compteMise").innerHTML = renderOptions(refData, "ordon");
  document.getElementById("compteCredit").innerHTML = renderOptions(refData, "ordon");
  document.getElementById("compteDebit").innerHTML = renderOptions(refData, "ordon");
  
  // R√©initialiser Choices.js
  if (ordonChoice) ordonChoice.destroy();
  if (benifChoice) benifChoice.destroy();
  if (compteReleveChoice) compteReleveChoice.destroy();
  if (compteMiseChoice) compteMiseChoice.destroy();
  if (compteCreditChoice) compteCreditChoice.destroy();
  if (compteDebitChoice) compteDebitChoice.destroy();
  
  ordonChoice = new Choices("#ordon", { searchPlaceholderValue: "Rechercher un compte..." });
  benifChoice = new Choices("#benif", { searchPlaceholderValue: "Rechercher un compte..." });
  compteReleveChoice = new Choices("#compteReleve", { searchPlaceholderValue: "Rechercher un compte..." });
  compteMiseChoice = new Choices("#compteMise", { searchPlaceholderValue: "Rechercher un compte..." });
  compteCreditChoice = new Choices("#compteCredit", { searchPlaceholderValue: "Rechercher un compte..." });
  compteDebitChoice = new Choices("#compteDebit", { searchPlaceholderValue: "Rechercher un compte..." });
}

// Charger le fichier Excel
function loadExcelFile() {
  const fileInput = document.getElementById('excelFile');
  const statusDiv = document.getElementById('uploadStatus');
  
  if (!fileInput.files.length) {
    statusDiv.innerHTML = '<div class="error">Veuillez s√©lectionner un fichier Excel. <a href="javascript:void(0)" onclick="toggleExcelTemplate()" style="color: #721c24; text-decoration: underline;">Voir le mod√®le requis</a></div>';
    return;
  }
  
  const file = fileInput.files[0];
  const reader = new FileReader();
  
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      
      // Supposer que la premi√®re feuille contient les donn√©es
      const firstSheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[firstSheetName];
      
      // Convertir en JSON
      const jsonData = XLSX.utils.sheet_to_json(worksheet);
      
      // Transformer les donn√©es au format attendu
      refData = jsonData.map(row => {
        return {
          ordon: row.Ordonneur || '',
          banque: row.BANQUE || '',
          agence: row.AGENCE || '',
          compte: row.Compte || '',
          benif: row.NOM || '',
          footer: row.F || ''
        };
      });
      
      // Filtrer les entr√©es vides
      refData = refData.filter(item => item.ordon && item.compte);
      
      // Mettre √† jour les s√©lecteurs
      initSelects();
      
      statusDiv.innerHTML = `<div class="success">‚úÖ ${refData.length} comptes charg√©s avec succ√®s</div>`;
      
    } catch (error) {
      console.error('Erreur lors du chargement du fichier:', error);
      statusDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}. <a href="javascript:void(0)" onclick="toggleExcelTemplate()" style="color: #721c24; text-decoration: underline;">V√©rifier le mod√®le Excel</a></div>`;
    }
  };
  
  reader.onerror = function() {
    statusDiv.innerHTML = '<div class="error">‚ùå Erreur lors de la lecture du fichier. <a href="javascript:void(0)" onclick="toggleExcelTemplate()" style="color: #721c24; text-decoration: underline;">Voir le mod√®le requis</a></div>';
  };
  
  reader.readAsArrayBuffer(file);
}

// Gestion du changement de type de document
document.getElementById("documentType").addEventListener("change", function() {
  const type = this.value;
  
  // Masquer tous les champs
  document.querySelector(".virement-fields").style.display = "none";
  document.querySelector(".mise-fields").style.display = "none";
  document.querySelector(".releve-fields").style.display = "none";
  document.querySelector(".credit-fields").style.display = "none";
  document.querySelector(".debit-fields").style.display = "none";
  
  // Afficher les champs correspondants
  if (type === "virement") {
    document.querySelector(".virement-fields").style.display = "block";
    // Afficher le mode par d√©faut (manuel)
    setVirementMode('manuel');
  } else if (type === "mise") {
    document.querySelector(".mise-fields").style.display = "block";
    setMiseMode('manuel');
  } else if (type === "releve") {
    document.querySelector(".releve-fields").style.display = "block";
    setReleveMode('manuel');
  } else if (type === "credit") {
    document.querySelector(".credit-fields").style.display = "block";
    setCreditMode('manuel');
  } else if (type === "debit") {
    document.querySelector(".debit-fields").style.display = "block";
    setDebitMode('manuel');
  }
});

// Conversion nombre ‚Üí lettres simplifi√©e
function numberToWords(n) {
  const unite = ["z√©ro","un","deux","trois","quatre","cinq","six","sept","huit","neuf","dix",
    "onze","douze","treize","quatorze","quinze","seize","dix-sept","dix-huit","dix-neuf"];
  const dizaines = ["","","vingt","trente","quarante","cinquante","soixante","soixante-dix","quatre-vingt","quatre-vingt-dix"];

  if (n < 20) return unite[n];
  if (n < 100) {
    let d = Math.floor(n/10), r = n%10;
    if (d===7 || d===9) return dizaines[d] + (r>0 ? "-" + unite[10+r] : "");
    return dizaines[d] + (r>0 ? "-" + unite[r] : "");
  }
  if (n < 1000) {
    let c = Math.floor(n/100), r = n%100;
    return (c>1?unite[c]+" ":"") + "cent" + (r>0?" "+numberToWords(r):"");
  }
  if (n < 1000000) {
    let m = Math.floor(n/1000), r = n%1000;
    return (m>1?numberToWords(m)+" ":"") + "mille" + (r>0?" "+numberToWords(r):"");
  }
  return n.toString();
}

// Fonction pour formater une date au format fran√ßais (jj/mm/aaaa)
function formatDate(dateString) {
  if (!dateString) return '';
  const date = new Date(dateString);
  const day = date.getDate().toString().padStart(2, '0');
  const month = (date.getMonth() + 1).toString().padStart(2, '0');
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
}

// G√©n√©rer le document
function generateDocument() {
  const documentType = document.getElementById("documentType").value;
  const date = document.getElementById("date").value || "";
  const showHeader = document.getElementById("headerCheckbox").checked;

  if (documentType === "virement") {
    generateVirement();
  } else if (documentType === "mise") {
    generateMise();
  } else if (documentType === "releve") {
    generateReleve();
  } else if (documentType === "credit") {
    generateCredit();
  } else if (documentType === "debit") {
    generateDebit();
  }
}

// G√©n√©rer l'ordre de virement
function generateVirement() {
  const date = document.getElementById("date").value || "";
  const ville = document.getElementById("ville").value || "Temara";
  const montantChiffre = parseInt(document.getElementById("montantChiffre").value) || 0;
  const montantLettre = montantChiffre > 0 ? numberToWords(montantChiffre) : "";
  const isSRBM = document.getElementById("srbm").checked;
  const showHeader = document.getElementById("headerCheckbox").checked;
  const motif = document.getElementById("motifVirement").value || "";

  let ordonName, ordonCompte, ordonBanq, benifName, benifCompte, benifBanq, footer;

  if (virementMode === 'manuel') {
    // Utiliser les valeurs manuelles
    ordonName = document.getElementById("emetteurManuel").value || "";
    ordonCompte = document.getElementById("compteEmetteurManuel").value || "";
    ordonBanq = document.getElementById("banqueEmetteurManuel").value || "";
    benifName = document.getElementById("beneficiaireManuel").value || "";
    benifCompte = document.getElementById("compteBeneficiaireManuel").value || "";
    benifBanq = document.getElementById("banqueBeneficiaireManuel").value || "";
    footer = ""; // Pas de footer en mode manuel
  } else {
    // Utiliser les valeurs Excel
    const ordonSel = document.getElementById("ordon").selectedOptions[0];
    const benifSel = document.getElementById("benif").selectedOptions[0];
    
    ordonBanq = ordonSel?.dataset.banq || "";
    const ordonAgence = ordonSel?.dataset.agence || "";
    ordonCompte = ordonSel?.value || "";
    ordonName = ordonSel?.dataset.name || "";
    benifName = benifSel?.dataset.name || "";
    benifBanq = benifSel?.dataset.banq || "";
    benifCompte = benifSel?.value || "";
    footer = ordonSel?.dataset.footer || "";

    // Construire l'adresse avec agence
    ordonBanq = ordonAgence ? `${ordonBanq} Agence ${ordonAgence}` : ordonBanq;
  }

  // Extraire le nom de la soci√©t√© √©mettrice (partie avant le tiret)
  const emetteurName = ordonName.split('-')[0] || ordonName;

  const template = `
${showHeader ? `<div class="letter-header">${emetteurName}</div>` : ''}

<div class="right"><b>${ville} le ${formatDate(date)}</b></div>

<div class="center">√Ä l'attention de Monsieur le Directeur<br><b>${ordonBanq}</b></div>

<div class="left">OBJET : Ordre de Virement${isSRBM ? ' (SRBM)' : ''}</div>

Monsieur,

Par le d√©bit de notre compte N¬∞ <b>${ordonCompte}</b>, veuillez virer la somme de <b>${montantChiffre} Dhs</b> (<b>${montantLettre}</b>) au profit de <b>${benifName}</b>, domicili√© √† <b>${benifBanq}</b> - Compte n¬∞ <b>${benifCompte}</b>.
${motif ? `\nMotif : <b>${motif}</b>` : ''}

<div class="signature"><b>Veuillez agr√©er, Monsieur le Directeur, l'expression de nos sentiments distingu√©s.</b></div>

${showHeader && footer ? `<div class="letter-footer">${footer}</div>` : ''}
`;

  document.getElementById("documentOutput").innerHTML = template;
}

function generateMise() {
  const date = document.getElementById("date").value || "";
  const ville = document.getElementById("ville").value || "Temara";
  const montantChiffre = parseInt(document.getElementById("montantMise").value) || 0;
  const montantLettre = montantChiffre > 0 ? numberToWords(montantChiffre) : "";
  const nomBeneficiaire = document.getElementById("nomBeneficiaire").value || "";
  const cinBeneficiaire = document.getElementById("cinBeneficiaire").value || "";
  const showHeader = document.getElementById("headerCheckbox").checked;

  let compteBanq, compteAgence, compteNum, compteFooter, emetteurName;

  if (miseMode === 'manuel') {
    // Utiliser les valeurs manuelles
    compteNum = document.getElementById("compteMiseManuel").value || "";
    compteBanq = document.getElementById("banqueMiseManuel").value || "";
    compteAgence = document.getElementById("agenceMiseManuel").value || "";
    compteFooter = "";
    emetteurName = "";
  } else {
    // Utiliser les valeurs Excel
    const compteSel = document.getElementById("compteMise").selectedOptions[0];
    compteBanq = compteSel?.dataset.banq || "";
    compteAgence = compteSel?.dataset.agence || "";
    compteNum = compteSel?.value || "";
    const compteName = compteSel?.dataset.name || "";
    compteFooter = compteSel?.dataset.footer || "";
    emetteurName = compteName.split('-')[0];
  }

  const adresseCompte = compteAgence ? `${compteBanq} Agence ${compteAgence}` : compteBanq;

  const template = `
${showHeader && emetteurName ? `<div class="letter-header">${emetteurName}</div>` : ''}

<div class="right"><b>${ville} le ${formatDate(date)}</b></div>

<div class="center">√Ä l'attention de Monsieur le Directeur<br><b>${adresseCompte}</b></div>

<div class="left">OBJET : Mise √† disposition</div>

Monsieur,

Nous vous demandons de d√©biter notre compte N¬∞ <b>${compteNum}</b> de la somme de <b>${montantChiffre} Dhs</b> (<b>${montantLettre}</b>) en faveur de <b>${nomBeneficiaire}</b> titulaire de la CIN N¬∞ <b>${cinBeneficiaire}</b>.

<div class="signature"><b>Veuillez agr√©er, Monsieur le Directeur, l'expression de nos sentiments distingu√©s.</b></div>

${showHeader && compteFooter ? `<div class="letter-footer">${compteFooter || ''}</div>` : ''}
`;

  document.getElementById("documentOutput").innerHTML = template;
}

function generateReleve() {
  const date = document.getElementById("date").value || "";
  const ville = document.getElementById("ville").value || "Temara";
  const mois = document.getElementById("moisReleve").value;
  const annee = document.getElementById("anneeReleve").value;
  const showHeader = document.getElementById("headerCheckbox").checked;

  let compteBanq, compteAgence, compteNum, compteFooter, emetteurName;

  if (releveMode === 'manuel') {
    // Utiliser les valeurs manuelles
    compteNum = document.getElementById("compteReleveManuel").value || "";
    compteBanq = document.getElementById("banqueReleveManuel").value || "";
    compteAgence = document.getElementById("agenceReleveManuel").value || "";
    compteFooter = "";
    emetteurName = "";
  } else {
    // Utiliser les valeurs Excel
    const compteSel = document.getElementById("compteReleve").selectedOptions[0];
    compteBanq = compteSel?.dataset.banq || "";
    compteAgence = compteSel?.dataset.agence || "";
    compteNum = compteSel?.value || "";
    const compteName = compteSel?.dataset.name || "";
    compteFooter = compteSel?.dataset.footer || "";
    emetteurName = compteName.split('-')[0];
  }

  const adresseCompte = compteAgence ? `${compteBanq} Agence ${compteAgence}` : compteBanq;

  const nomsMois = {
    "01": "janvier", "02": "f√©vrier", "03": "mars", "04": "avril", 
    "05": "mai", "06": "juin", "07": "juillet", "08": "ao√ªt", 
    "09": "septembre", "10": "octobre", "11": "novembre", "12": "d√©cembre"
  };

  const template = `
${showHeader && emetteurName ? `<div class="letter-header">${emetteurName}</div>` : ''}

<div class="right"><b>${ville} le ${formatDate(date)}</b></div>

<div class="center">√Ä l'attention de Monsieur le Directeur<br><b>${adresseCompte}</b></div>

<div class="left">OBJET : Demande de Relev√© de Compte</div>

Monsieur,

Nous vous prions de bien vouloir nous √©tablir le relev√© de notre compte N¬∞ <b>${compteNum}</b> pour le mois de <b>${nomsMois[mois]} ${annee}</b>.

<div class="signature"><b>Veuillez agr√©er, Monsieur le Directeur, l'expression de nos sentiments distingu√©s.</b></div>

${showHeader && compteFooter ? `<div class="letter-footer">${compteFooter || ''}</div>` : ''}
`;

  document.getElementById("documentOutput").innerHTML = template;
}

function generateCredit() {
  const date = document.getElementById("date").value || "";
  const ville = document.getElementById("ville").value || "Temara";
  const dateOperation = document.getElementById("dateOperationCredit").value || "";
  const montantChiffre = parseInt(document.getElementById("montantCredit").value) || 0;
  const montantLettre = montantChiffre > 0 ? numberToWords(montantChiffre) : "";
  const libelle = document.getElementById("libelleCredit").value || "";
  const showHeader = document.getElementById("headerCheckbox").checked;

  let compteBanq, compteAgence, compteNum, compteFooter, emetteurName;

  if (creditMode === 'manuel') {
    // Utiliser les valeurs manuelles
    compteNum = document.getElementById("compteCreditManuel").value || "";
    compteBanq = document.getElementById("banqueCreditManuel").value || "";
    compteAgence = document.getElementById("agenceCreditManuel").value || "";
    compteFooter = "";
    emetteurName = "";
  } else {
    // Utiliser les valeurs Excel
    const compteSel = document.getElementById("compteCredit").selectedOptions[0];
    compteBanq = compteSel?.dataset.banq || "";
    compteAgence = compteSel?.dataset.agence || "";
    compteNum = compteSel?.value || "";
    const compteName = compteSel?.dataset.name || "";
    compteFooter = compteSel?.dataset.footer || "";
    emetteurName = compteName.split('-')[0];
  }

  const adresseCompte = compteAgence ? `${compteBanq} Agence ${compteAgence}` : compteBanq;

  const template = `
${showHeader && emetteurName ? `<div class="letter-header">${emetteurName}</div>` : ''}

<div class="right"><b>${ville} le ${formatDate(date)}</b></div>

<div class="center">√Ä l'attention de Monsieur le Directeur<br><b>${adresseCompte}</b></div>

<div class="left">OBJET : Demande d'avis de cr√©dit</div>

Monsieur,

Nous vous prions de bien vouloir nous cr√©diter notre compte N¬∞ <b>${compteNum}</b> de la somme de <b>${montantChiffre} Dhs</b> (<b>${montantLettre}</b>) pour la raison suivante : <b>${libelle}</b>.

<div class="signature"><b>Veuillez agr√©er, Monsieur le Directeur, l'expression de nos sentiments distingu√©s.</b></div>

${showHeader && compteFooter ? `<div class="letter-footer">${compteFooter || ''}</div>` : ''}
`;

  document.getElementById("documentOutput").innerHTML = template;
}

function generateDebit() {
  const date = document.getElementById("date").value || "";
  const ville = document.getElementById("ville").value || "Temara";
  const dateOperation = document.getElementById("dateOperationDebit").value || "";
  const montantChiffre = parseInt(document.getElementById("montantDebit").value) || 0;
  const montantLettre = montantChiffre > 0 ? numberToWords(montantChiffre) : "";
  const libelle = document.getElementById("libelleDebit").value || "";
  const showHeader = document.getElementById("headerCheckbox").checked;

  let compteBanq, compteAgence, compteNum, compteFooter, emetteurName;

  if (debitMode === 'manuel') {
    // Utiliser les valeurs manuelles
    compteNum = document.getElementById("compteDebitManuel").value || "";
    compteBanq = document.getElementById("banqueDebitManuel").value || "";
    compteAgence = document.getElementById("agenceDebitManuel").value || "";
    compteFooter = "";
    emetteurName = "";
  } else {
    // Utiliser les valeurs Excel
    const compteSel = document.getElementById("compteDebit").selectedOptions[0];
    compteBanq = compteSel?.dataset.banq || "";
    compteAgence = compteSel?.dataset.agence || "";
    compteNum = compteSel?.value || "";
    const compteName = compteSel?.dataset.name || "";
    compteFooter = compteSel?.dataset.footer || "";
    emetteurName = compteName.split('-')[0];
  }

  const adresseCompte = compteAgence ? `${compteBanq} Agence ${compteAgence}` : compteBanq;

  const template = `
${showHeader && emetteurName ? `<div class="letter-header">${emetteurName}</div>` : ''}

<div class="right"><b>${ville} le ${formatDate(date)}</b></div>

<div class="center">√Ä l'attention de Monsieur le Directeur<br><b>${adresseCompte}</b></div>

<div class="left">OBJET : Demande d'avis de d√©bit</div>

Monsieur,

Nous vous prions de bien vouloir d√©biter notre compte N¬∞ <b>${compteNum}</b> de la somme de <b>${montantChiffre} Dhs</b> (<b>${montantLettre}</b>) pour la raison suivante : <b>${libelle}</b>.

<div class="signature"><b>Veuillez agr√©er, Monsieur le Directeur, l'expression de nos sentiments distingu√©s.</b></div>

${showHeader && compteFooter ? `<div class="letter-footer">${compteFooter || ''}</div>` : ''}
`;

  document.getElementById("documentOutput").innerHTML = template;
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
  initAnnees();
  document.querySelector(".virement-fields").style.display = "block";
  setVirementMode('manuel'); // Mode manuel par d√©faut
  
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('date').value = today;
  document.getElementById('dateOperationCredit').value = today;
  document.getElementById('dateOperationDebit').value = today;
});
</script>
</body>
</html>
